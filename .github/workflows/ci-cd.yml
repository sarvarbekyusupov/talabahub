name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  DOCKER_IMAGE: talabahub-backend

jobs:
  # ==========================================
  # Job 1: Lint and Type Check
  # ==========================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test?schema=public"
        run: npx prisma generate

      - name: Run ESLint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

  # ==========================================
  # Job 2: Unit Tests
  # ==========================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test?schema=public"
        run: npx prisma generate

      - name: Run tests
        run: npm run test

  # ==========================================
  # Job 3: Build Docker Image
  # ==========================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:main
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ==========================================
  # Job 4: Security Scan
  # ==========================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ==========================================
  # Job 5: Deploy to Production
  # ==========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: http://3.121.174.54:3030

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # Create directory in home folder (ubuntu user has permission)
            mkdir -p ~/talabahub-backend
            cd ~/talabahub-backend

            # Create .env file if it doesn't exist
            if [ ! -f .env ]; then
              echo "Creating default .env file..."
              cat > .env << 'ENVEOF'
            # Database
            DB_USER=talabahub
            DB_PASSWORD=talabahub_secure_password_change_me
            DB_NAME=talabahub
            DB_PORT=5432

            # Redis
            REDIS_PASSWORD=redis_secure_password_change_me
            REDIS_PORT=6379

            # JWT Secrets (CHANGE THESE!)
            JWT_ACCESS_SECRET=change_this_to_random_secret_key_min_32_chars
            JWT_REFRESH_SECRET=change_this_to_another_random_secret_key_min_32_chars

            # Email (Configure your email provider)
            MAIL_HOST=smtp.gmail.com
            MAIL_PORT=587
            MAIL_USER=your-email@gmail.com
            MAIL_PASSWORD=your-app-password
            MAIL_FROM=noreply@talabahub.com

            # Cloudinary (Optional - for file uploads)
            CLOUDINARY_CLOUD_NAME=
            CLOUDINARY_API_KEY=
            CLOUDINARY_API_SECRET=

            # Frontend URL
            FRONTEND_URL=http://localhost:5173

            # Rate limiting
            THROTTLE_TTL=60000
            THROTTLE_LIMIT=10
            ENVEOF
              echo "‚ö†Ô∏è  .env file created with default values. Please update with real credentials!"
            fi

            # Create logs directory
            mkdir -p logs

            # Stop and remove ALL old containers to free up ports
            echo "üßπ Cleaning up old containers..."
            docker stop talabahub-backend talabahub-postgres talabahub-redis 2>/dev/null || true
            docker rm talabahub-backend talabahub-postgres talabahub-redis 2>/dev/null || true
            docker compose -f docker-compose.prod.yml down 2>/dev/null || true

            # Kill any process using ports 5432 and 6379
            echo "üîç Checking for processes using ports 5432 and 6379..."
            sudo lsof -ti:5432 | xargs -r sudo kill -9 2>/dev/null || true
            sudo lsof -ti:6379 | xargs -r sudo kill -9 2>/dev/null || true

            # Double check - stop ANY container using these ports
            docker ps -q --filter "publish=5432" | xargs -r docker stop 2>/dev/null || true
            docker ps -q --filter "publish=6379" | xargs -r docker stop 2>/dev/null || true

            sleep 2

            # Create docker-compose.prod.yml
            cat > docker-compose.prod.yml << 'EOF'
            services:
              postgres:
                image: postgres:16-alpine
                container_name: talabahub-postgres
                restart: unless-stopped
                environment:
                  POSTGRES_USER: ${DB_USER:-talabahub}
                  POSTGRES_PASSWORD: ${DB_PASSWORD:-talabahub_password}
                  POSTGRES_DB: ${DB_NAME:-talabahub}
                ports:
                  - '${DB_PORT:-5432}:5432'
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                healthcheck:
                  test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-talabahub}']
                  interval: 10s
                  timeout: 5s
                  retries: 5
                networks:
                  - talabahub-network

              redis:
                image: redis:7-alpine
                container_name: talabahub-redis
                restart: unless-stopped
                ports:
                  - '${REDIS_PORT:-6379}:6379'
                volumes:
                  - redis_data:/data
                command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
                healthcheck:
                  test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
                  interval: 10s
                  timeout: 3s
                  retries: 5
                networks:
                  - talabahub-network

              backend:
                image: ${{ secrets.DOCKER_USERNAME }}/talabahub-backend:main
                container_name: talabahub-backend
                restart: unless-stopped
                ports:
                  - '3030:3000'
                environment:
                  NODE_ENV: production
                  PORT: 3000
                  DATABASE_URL: postgresql://${DB_USER:-talabahub}:${DB_PASSWORD:-talabahub_password}@postgres:5432/${DB_NAME:-talabahub}?schema=public&connection_limit=10&pool_timeout=20
                  REDIS_HOST: redis
                  REDIS_PORT: 6379
                  REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password}
                  JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
                  JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
                  CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
                  CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
                  CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
                  MAIL_HOST: ${MAIL_HOST}
                  MAIL_PORT: ${MAIL_PORT}
                  MAIL_USER: ${MAIL_USER}
                  MAIL_PASSWORD: ${MAIL_PASSWORD}
                  MAIL_FROM: ${MAIL_FROM}
                  FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
                  THROTTLE_TTL: ${THROTTLE_TTL:-60000}
                  THROTTLE_LIMIT: ${THROTTLE_LIMIT:-10}
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                volumes:
                  - ./logs:/app/logs
                healthcheck:
                  test: ['CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:3000/api/health/live || exit 1']
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
                networks:
                  - talabahub-network

            volumes:
              postgres_data:
                driver: local
              redis_data:
                driver: local

            networks:
              talabahub-network:
                driver: bridge
            EOF

            echo "üì¶ Pulling latest images..."
            docker compose -f docker-compose.prod.yml pull

            echo "üöÄ Starting services..."
            docker compose -f docker-compose.prod.yml up -d

            echo "‚è≥ Waiting 30s for startup..."
            sleep 30

            echo "üìã Container status:"
            docker compose -f docker-compose.prod.yml ps

            echo "üìù Recent logs:"
            docker compose -f docker-compose.prod.yml logs --tail=30 backend

            echo "üè• Health check..."
            for i in 1 2 3 4 5; do
              if curl -sf http://localhost:3030/api/health/live > /dev/null; then
                echo "‚úÖ Deployment successful!"
                docker image prune -f
                exit 0
              fi
              echo "Attempt $i/5 failed, retrying in 5s..."
              sleep 5
            done

            echo "‚ùå Health check failed!"
            docker compose -f docker-compose.prod.yml logs --tail=100 backend
            exit 1

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Production deployment successful!"
          else
            echo "‚ùå Production deployment failed!"
          fi
